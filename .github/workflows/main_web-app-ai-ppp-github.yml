# .github/workflows/docker-webapp.yml
name: Build & deploy container to Azure Web App - WEB-APP-AI-PPP-GITHUB

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  DOCKERHUB_NAMESPACE: pedromoraes20
  IMAGE_NAME: ai-ppp-app

  AZURE_WEBAPP_NAME: WEB-APP-AI-PPP-GITHUB
  WEBSITES_PORT: "8000"
  WEBSITES_CONTAINER_START_TIME_LIMIT: "1800"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    outputs:
      image_latest: ${{ steps.meta.outputs.image_latest }}
      image_sha: ${{ steps.meta.outputs.image_sha }}

    steps:
      - uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Set image tags
        id: meta
        run: |
          echo "image_latest=${DOCKERHUB_NAMESPACE}/${IMAGE_NAME}:latest" >> $GITHUB_OUTPUT
          echo "image_sha=${DOCKERHUB_NAMESPACE}/${IMAGE_NAME}:${GITHUB_SHA}" >> $GITHUB_OUTPUT

      - name: Build & push (latest + sha)
        run: |
          docker build -t "${{ steps.meta.outputs.image_sha }}" -t "${{ steps.meta.outputs.image_latest }}" .
          docker push "${{ steps.meta.outputs.image_sha }}"
          docker push "${{ steps.meta.outputs.image_latest }}"

  deploy:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Login to Azure (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_3FADEC731D1E4CA0B3F7C030CEB2E9F5 }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_6B8A7E8286D648C4A3F2ADDA0D4A0D08 }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_6588AB6004B04C97BC7F594D93D672EE }}

      - name: Resolve resource group (by Web App name)
        id: rg
        shell: bash
        run: |
          RG=$(az webapp list --query "[?name=='${AZURE_WEBAPP_NAME}'].resourceGroup | [0]" -o tsv)
          if [ -z "$RG" ]; then
            echo "Could not find resource group for ${AZURE_WEBAPP_NAME}. Check permissions or app name."
            exit 1
          fi
          echo "RG=$RG" >> $GITHUB_ENV

      - name: Set App Settings (port + startup time + Docker Hub creds)
        shell: bash
        run: |
          az webapp config appsettings set \
            --name "${AZURE_WEBAPP_NAME}" \
            --resource-group "${RG}" \
            --settings \
              WEBSITES_PORT="${WEBSITES_PORT}" \
              WEBSITES_CONTAINER_START_TIME_LIMIT="${WEBSITES_CONTAINER_START_TIME_LIMIT}" \
              DOCKER_REGISTRY_SERVER_URL="https://index.docker.io/v1" \
              DOCKER_REGISTRY_SERVER_USERNAME="${{ secrets.DOCKERHUB_USERNAME }}" \
              DOCKER_REGISTRY_SERVER_PASSWORD="${{ secrets.DOCKERHUB_PASSWORD }}"

      - name: Deploy container image to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          slot-name: Production
          images: ${{ needs.build.outputs.image_latest }}
